<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gran Rifa ‚Äì Moto CR4 Repotenciada Y 1M Semanal</title>
    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        // Listener para la verificaci√≥n de boleta, asegurando que est√© disponible desde el inicio
        document.addEventListener('DOMContentLoaded', () => {
             const verifyInput = document.getElementById('verifyNum');
             if (verifyInput) {
                verifyInput.addEventListener('input', verifyTicket);
             }
        });
    </script>
    <style>
        /* --- TEMA OSCURO (NATIVO Y FIXED) --- */
        :root {
            --primary: #00ff84; /* Verde Ne√≥n */
            --secondary: #004bce; /* Azul El√©ctrico */
            --accent: #ff0033; /* Rojo Intenso */
            --warning: #ffea00; /* Amarillo Brillante */
            --bg-body: #050505; /* Negro Puro */
            --bg-card: #141414; /* Gris Muy Oscuro */
            --text-main: #9ddbff;
            --text-muted: #968f8f;
            --border: #7e5c5c;
            --shadow: 0 0 20px rgba(0,0,0,0.7);
        }

        /* --- TEMA CLARO (OPCIONAL) --- */
        .light-mode {
            --primary: #2ecc71;
            --secondary: #2d9cdb;
            --accent: #e74c3c;
            --warning: #f1c40f;
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #ecf0f1;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* --- ESTILOS BASE --- */
        * { box-sizing: border-box; font-family: 'Segoe UI', Inter, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; padding-bottom: 80px; }

        /* HEADER */
        header {
            padding: 15px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;
            box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo {
            width: 45px; height: 45px; border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), var(--warning));
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-weight: 900; font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(255, 23, 68, 0.5);
            animation: pulse 2s infinite alternate;
        }
        @keyframes pulse { to { box-shadow: 0 0 25px rgba(255, 23, 68, 0.8); transform: scale(1.05); } }
        
        .controls { display: flex; gap: 10px; align-items: center; }

        /* BOTONES */
        button, .btn {
            cursor: pointer; padding: 10px 18px; border-radius: 8px; border: 0;
            background: var(--secondary); color: #fff; font-weight: 700; font-size: 0.95rem;
            transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        button:hover, .btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        button:active { transform: scale(0.98); }
        .btn.accent { background: var(--accent); }
        .btn.outline { background: transparent; border: 2px solid var(--border); color: var(--text-main); }
        .btn.warning { background: var(--warning); color: var(--bg-body) !important; }
        
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* IMAGEN / BANNER */
        .raffle-banner {
            width: 100%; border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid var(--border);
            position: relative;
        }
        .raffle-banner img { width: 100%; height: auto; max-height: 400px; object-fit: cover; display: block; }
        
        /* CONTADOR */
        .countdown-box {
            display: flex; justify-content: space-around; background: var(--bg-card); 
            padding: 15px; border-radius: 16px; margin-bottom: 25px;
            border: 1px solid var(--border); box-shadow: var(--shadow);
            text-align: center;
        }
        .countdown-item { padding: 5px 10px; border-radius: 6px; }
        .countdown-val { font-size: 2rem; font-weight: 900; color: var(--accent); }
        .countdown-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); }

        /* ESTRUCTURA */
        .hero { display: grid; grid-template-columns: 1fr 340px; gap: 25px; }
        @media (max-width: 900px) { .hero { grid-template-columns: 1fr; } }

        .panel {
            background: var(--bg-card); padding: 20px; border-radius: 16px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }

        /* GRID DE BOLETAS */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-input {
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main); font-weight: 600;
        }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 8px; max-height: 600px; overflow-y: auto; padding: 5px;
        }
        .card {
            background: var(--bg-body); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px 5px; text-align: center;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .card:hover { transform: scale(1.1); z-index: 10; border-color: var(--text-main); }
        
        /* Tooltip de Info del Due√±o */
        .card:hover::after {
            content: attr(data-owner-info);
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: var(--bg-body); color: var(--primary); padding: 5px 10px;
            border-radius: 5px; white-space: nowrap; font-size: 0.7rem;
            border: 1px solid var(--primary); z-index: 11;
            display: block; opacity: 1;
        }
        .card[data-owner-info=""]::after { display: none; }

        .num { font-weight: 900; font-size: 1.2rem; letter-spacing: 1px; }
        .status-text { font-size: 0.6rem; text-transform: uppercase; margin-top: 4px; font-weight: 700; }

        /* ESTADOS DE BOLETA */
        .card.available { border-color: var(--primary); color: var(--text-main); }
        .card.available .num { color: var(--primary); }
        .card.available.selected { background: var(--primary); color: var(--bg-body) !important; transform: scale(1.1); }
        .card.available.selected .num { color: var(--bg-body); }
        .card.available:hover { background: var(--primary); color: #000 !important; }
        .card.available:hover .num { color: #000; }

        .card.reserved { border-color: var(--warning); background: rgba(255, 234, 0, 0.15); opacity: 0.8; }
        .card.reserved .num { color: var(--warning); }
        .card.reserved.mine { border-color: var(--secondary); animation: blink-res 1s infinite alternate; }
        @keyframes blink-res { from { opacity: 0.9; } to { opacity: 0.6; } }
        
        .card.paid { border-color: var(--accent); background: rgba(255, 23, 68, 0.15); opacity: 0.7; }
        .card.paid .num { color: var(--accent); text-decoration: none; }

        /* SIDEBAR / INFO */
        .cta-box { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .cta-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: var(--bg-body); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.4rem; font-weight: 800; display: block; }
        
        /* FOOTER */
        footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; margin-top: 30px; border-top: 1px solid var(--border); }

        /* MODALES */
        .modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.open { display: flex; opacity: 1; }
        .dialog {
            background: var(--bg-card); padding: 30px; border-radius: 20px;
            width: 90%; max-width: 450px; border: 1px solid var(--border);
            box-shadow: 0 0 50px rgba(0,0,0,0.7);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal.open .dialog { transform: scale(1); }
        .dialog h3 { margin-top: 0; color: var(--secondary); font-size: 1.5rem; }
        .dialog input, .dialog select { 
            width: 100%; padding: 12px; margin: 10px 0; background: var(--bg-body); 
            border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; 
            font-weight: 600;
        }

        /* ESTILOS ESPEC√çFICOS ADMIN MODAL */
        #adminModal .dialog { 
            max-width: 700px; 
            max-height: 90vh; 
            overflow-y: auto; 
            padding-bottom: 10px;
        }
        .admin-list-container {
            background:var(--bg-body); 
            height: 200px; 
            overflow-y: auto; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 5px; 
            margin-bottom: 15px;
        }
        .admin-table { width:100%; font-size: 0.8rem; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 5px; text-align: left;}


        /* WHATSAPP FLOTANTE */
        .float-wa {
            position: fixed; bottom: 20px; right: 20px; z-index: 1500;
            background: #25D366; color: white; padding: 12px 20px;
            border-radius: 50px; font-weight: bold; text-decoration: none;
            box-shadow: 0 0 20px rgba(37, 211, 102, 0.6);
            display: flex; align-items: center; gap: 10px; transition: transform 0.3s;
        }
        .float-wa:hover { transform: scale(1.1); }

        /* TOAST */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast {
            background: var(--bg-card); color: var(--text-main); padding: 15px 20px;
            margin-bottom: 10px; border-radius: 8px; border-left: 5px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s;
        }
        .toast.success { border-left-color: var(--primary); }
        .toast.warning { border-left-color: var(--warning); color: var(--bg-body); }
        .toast.error { border-left-color: var(--accent); }
        .toast.accent { border-left-color: var(--accent); color: var(--accent); } /* Added accent color for weekly cuttoff */
        
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="logo">GR</div>
            <div>
                <h1 style="color: var(--text-main);">Gran Rifa - Moto CR4 150 y 1M Semanal - Que Esperas</h1>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Sorteo final: 30/01/2026 </div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Cada Viernes se Rifa 1M hasta el 23/01/2026. Gran Sorteo 30/01/2026. **Loter√≠a Santander 10:00 PM**</div>
            </div>
        </div>
        <div class="controls">
            <button onclick="openWinnerHistory()" class="btn secondary" style="font-size: 0.8rem; padding: 8px 12px;">üèÜ Ganadores</button>
            <button onclick="toggleTheme()" class="btn outline" title="Cambiar Tema">üåó</button>
            <button id="btnAuth" onclick="openModal('loginModal')" class="btn secondary">Ingresar</button>
            <button id="btnAdmin" onclick="openAdminAuth()" class="btn accent">Admin</button> </div>
    </header>

    <main>
        <div class="raffle-banner">
            <img src="Rifa.jpg" alt="Rifa Moto CR4" onerror="this.src='https://via.placeholder.com/1200x400/121212/e74c3c?text=IMAGEN+NO+ENCONTRADA+(Rifa.jpg)';">
        </div>
        
        <div class="countdown-box">
            <div style="text-align: center; flex: 1; border-right: 1px solid var(--border);">
                <div style="font-weight: 800; color: var(--primary); margin-bottom: 5px;">PR√ìXIMO SORTEO SEMANAL</div>
                <div class="countdown-item">
                    <span id="nextDrawTime" class="countdown-val" style="color:var(--warning);">--:--:--</span>
                    <div class="countdown-label">Tiempo Restante (Viernes 10 PM)</div>
                </div>
            </div>
            <div style="text-align: center; flex: 1;">
                <div style="font-weight: 800; color: var(--accent); margin-bottom: 5px;">GRAN SORTEO FINAL (Moto)</div>
                <div class="countdown-item">
                    <span id="finalDrawTime" class="countdown-val">--:--:--</span>
                    <div class="countdown-label">Tiempo Restante</div>
                </div>
            </div>
        </div>

        <div class="hero">
            <div class="panel">
                <div class="toolbar">
                    <h2 style="margin:0; flex:1; color: var(--secondary);">Selecciona tu(s) N√∫mero(s) (M√°x 3)</h2>
                    <button onclick="refreshData()" class="btn outline" style="padding: 5px 10px; font-size: 0.8rem;">üîÑ Actualizar</button>
                </div>
                <div class="toolbar">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar n√∫mero (000 - 999)...">
                    <select id="filterSelect" class="search-input" style="flex: 0 0 140px;">
                        <option value="all">Todos</option>
                        <option value="available">Disponibles</option>
                        <option value="reserved">Reservados</option>
                        <option value="paid">Pagados</option>
                    </select>
                </div>
                
                <div id="grid" class="grid"></div>
            </div>

            <div class="panel">
                <div class="cta-box">
                    <div class="cta-title">üìä Estad√≠sticas</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span id="statAvail" class="stat-val" style="color:var(--primary)">0</span><span style="font-size:0.7rem">LIBRES</span></div>
                        <div class="stat-item"><span id="statRes" class="stat-val" style="color:var(--warning)">0</span><span style="font-size:0.7rem">RESERVADOS</span></div>
                        <div class="stat-item"><span id="statPaid" class="stat-val" style="color:var(--accent)">0</span><span style="font-size:0.7rem">PAGADOS</span></div>
                        <div class="stat-item"><span id="statTotal" class="stat-val">1000</span><span style="font-size:0.7rem">TOTAL</span></div>
                    </div>
                </div>

                <div class="cta-box">
                    <div class="cta-title">üí∞ Compra tu Boleta</div>
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary); margin-bottom: 15px;">
                        <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary); text-align: center;">$25.000 COP</div>
                        <div style="text-align: center; font-size: 0.8rem; color: var(--text-muted);">Valor por boleta</div>
                    </div>
                    
                    <button id="multiReserveBtn" onclick="confirmReservation()" class="btn accent" style="width:100%; margin-bottom:10px; display: none;">
                        ‚úÖ Reservar (<span id="selectedCount">0</span>) N√∫meros
                    </button>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                        <button onclick="quickBuy(1)" class="btn secondary" style="font-size: 0.85rem; padding: 10px 5px;">1 Boleta</button>
                        <button onclick="quickBuy(2)" class="btn secondary" style="font-size: 0.85rem; padding: 10px 5px;">2 Boletas</button>
                        <button onclick="quickBuy(3)" class="btn secondary" style="font-size: 0.85rem; padding: 10px 5px;">3 Boletas</button>
                    </div>
                    <button onclick="showInstructions()" class="btn secondary" style="width:100%; margin-bottom:10px;">üìÑ ¬øC√≥mo pagar?</button>
                    <button onclick="checkMyTickets()" class="btn outline" style="width:100%">üéüÔ∏è Ver Mis Boletas</button>
                    <button onclick="openModal('verifyModal')" class="btn secondary" style="width:100%; margin-top:10px;">üîç Verificar Boleta</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Responsable: <strong>√ìscar Fidel Fl√≥rez Tami</strong> | üìû 321 963 7388</p>
        <p>Entre mas te demores menos oportunidades, haslo ya para mas oportunidades</p>
        <button onclick="exportPaidTickets()" class="btn outline" style="font-size: 0.8rem; padding: 5px 10px; margin-top: 10px;">Descargar Listado de Boletas Pagadas (Transparencia)</button>
    </footer>

    <a href="https://wa.me/573219637388" class="float-wa" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M13.6 2.3A7.9 7.9 0 0 0 8 0a7.9 7.9 0 0 0-7.9 7.9c0 1.4.4 2.8 1 4L0 16l4.2-1.1a7.9 7.9 0 0 0 3.8 1h.1a7.9 7.9 0 0 0 7.9-7.9A7.9 7.9 0 0 0 13.6 2.3zM8 14.5a6.6 6.6 0 0 1-3.4-.9l-.2-.1-2.5.7.7-2.4-.2-.3a6.6 6.6 0 0 1 1-3.5A6.6 6.6 0 0 1 8 1.4a6.6 6.6 0 0 1 6.6 6.6 6.6 6.6 0 0 1-6.6 6.5z"/></svg>
        Contactar Administrador
    </a>

    <div id="toast-container"></div>

    <div id="loginModal" class="modal">
        <div class="dialog">
            <h3 id="loginTitle">üë§ Identif√≠cate</h3> 
            <p style="color:var(--text-muted)">Necesitamos tus datos para registrar las boletas a tu nombre.</p>
            <form onsubmit="handleLogin(event); return false;">
                <input type="text" id="userName" placeholder="üòë Nombre Completo" required>
                <input type="email" id="userEmail" placeholder="‚úâÔ∏è Correo Electr√≥nico (Para tracking interno)" required>
                <input type="tel" id="userPhone" placeholder="üìû Celular / WhatsApp" required>
                <button type="submit" class="btn secondary" style="width:100%; margin-top:10px;">Guardar y Continuar üëç</button>
            </form>
            <button onclick="closeModal('loginModal')" class="btn outline" style="width:100%; margin-top:10px;">‚úñÔ∏è Cancelar</button>
        </div>
    </div>
    
    <div id="verifyModal" class="modal">
        <div class="dialog">
            <h3>üîç Verificar Estado de Boleta</h3>
            <p style="color:var(--text-muted)">Ingresa el n√∫mero de 3 d√≠gitos para ver su estado actual (transparencia).</p>
            <form onsubmit="return false;">
                <input type="text" id="verifyNum" placeholder="N√∫mero (ej: 045)" pattern="\d{3}" maxlength="3" required>
                <div id="verifyResult" style="margin-top: 15px; padding: 10px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); min-height: 50px;">
                    <p style="color:var(--text-muted); margin:0;">Escribe un n√∫mero para verificar...</p>
                </div>
            </form>
            <button onclick="closeModal('verifyModal')" class="btn outline" style="width:100%; margin-top:15px;">‚úñÔ∏è Cerrar</button>
        </div>
    </div>

    
    <div id="winnerHistoryModal" class="modal">
        <div class="dialog" style="max-width: 600px;">
            <h3 style="color:var(--warning);">üèÜ Historial de Sorteos</h3>
            <p id="drawsRemaining" style="color:var(--text-muted); font-weight: bold;"></p>
            <div style="background:var(--bg-body); max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                <table class="admin-table">
                    <thead style="text-align:left; color: var(--primary); position: sticky; top: -10px; background: var(--bg-body); z-index: 5;">
                        <tr><th>Fecha</th><th>Sorteo</th><th>N√∫mero</th><th>Ganador</th></tr>
                    </thead>
                    <tbody id="winnerListBody"></tbody>
                </table>
            </div>
            <button id="btnAdminDeleteWinner" onclick="deleteWinnerHistory()" class="btn accent" style="font-size: 0.8rem; padding: 8px 12px; margin-top: 15px; display: none;">üóëÔ∏è Eliminar Historial de Ganadores</button>
            <button onclick="closeModal('winnerHistoryModal')" class="btn outline" style="width:100%; margin-top:15px;">‚úñÔ∏è Cerrar</button>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="dialog">
            <h3>üõ°Ô∏è Panel de Administrador</h3>
            
            <div style="display:flex; gap:10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="openManualAssignModal()" class="btn secondary" style="font-size: 0.85rem;">üìù Asignar Manual</button>
                <button onclick="openWinnerManagement()" class="btn warning" style="font-size: 0.85rem;">üèÖ Gesti√≥n Sorteos</button>
                <button onclick="exportAllData()" class="btn secondary" style="font-size: 0.85rem;">üì• Descargar Todo</button>
                <button onclick="adminResetRaffle()" class="btn accent" style="font-size: 0.85rem;">‚ö†Ô∏è Borrar Todo (Reset)</button>
            </div>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <h4>üìã Reservadas (Pendientes)</h4>
                    <div class="admin-list-container">
                        <table class="admin-table">
                            <thead style="text-align:left; color: var(--secondary);">
                                <tr><th>Num</th><th style="width:60%">Reservado por (Fecha)</th><th>Acci√≥n</th></tr>
                            </thead>
                            <tbody id="reservedTicketListBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div style="flex: 1; min-width: 250px;">
                    <h4>üî¥ Pagadas (Gesti√≥n)</h4>
                    <div class="admin-list-container">
                        <table class="admin-table">
                            <thead style="text-align:left; color: var(--secondary);">
                                <tr><th>Num</th><th>Due√±o</th><th>Acci√≥n</th></tr>
                            </thead>
                            <tbody id="paidTicketListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <h4>üë• Historial de Clientes</h4>
            <input type="text" id="adminUserSearch" placeholder="üîç Buscar cliente por nombre o tel√©fono..." oninput="renderUserList()" style="width:100%; margin-bottom: 10px;">
            <div class="admin-list-container" style="height: 150px;">
                <table class="admin-table">
                    <thead style="text-align:left; color: var(--secondary);">
                        <tr><th>Nombre</th><th>Celular</th><th>Estado</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="userListBody"></tbody>
                </table>
            </div>

            <button onclick="closeModal('adminModal')" class="btn outline" style="width:100%; margin-top:10px;">‚úñÔ∏è Cerrar Panel</button>
        </div>
    </div>

    <div id="manualAssignModal" class="modal">
        <div class="dialog">
            <h3>üìù Asignar Boleta Manualmente</h3>
            <p style="color:var(--text-muted)">Para ventas directas, se requiere el n√∫mero, nombre y celular.</p>
            <form onsubmit="return false;">
                <input type="text" id="manualNum" placeholder="N√∫mero de Boleta (ej: 045)" pattern="\d{3}" maxlength="3" required>
                <input type="text" id="manualName" placeholder="Nombre Completo del Cliente" required>
                <input type="tel" id="manualPhone" placeholder="Celular / WhatsApp" required>
                
                <button onclick="handleManualAssign(event, 'paid')" type="button" class="btn accent" style="width:100%; margin-top:15px;">
                    Asignar y Marcar como Pagada ‚úÖ
                </button>
                
                <button onclick="handleManualAssign(event, 'reserved')" type="button" class="btn warning" style="width:100%; margin-top:10px;">
                    Asignar y Marcar como Reservada ‚è≥
                </button>
            </form>
            <button onclick="closeModal('manualAssignModal')" class="btn outline" style="width:100%; margin-top:10px;">‚úñÔ∏è Cancelar</button>
        </div>
    </div>
    
    <div id="winnerManagementModal" class="modal">
        <div class="dialog">
            <h3>üèÖ Registrar Ganador de Sorteo</h3>
            <p style="color:var(--text-muted)">Registre manualmente el resultado del sorteo de Loter√≠a.</p>
            <form onsubmit="return false;">
                <input type="date" id="winnerDate" required>
                <input type="text" id="winnerNum" placeholder="N√∫mero Ganador (ej: 123)" pattern="\d{3}" maxlength="3" required>
                <select id="winnerType" style="margin-bottom: 0;">
                    <option value="weekly">Sorteo Semanal (1M)</option>
                    <option value="final">Gran Sorteo Final (Moto)</option>
                </select>
                <script>document.getElementById('winnerNum').addEventListener('input', previewWinnerInfo);</script> 
                <p id="winnerInfo" style="font-size: 0.9rem; color: var(--text-main); margin: 5px 0 15px 0;"></p>

                <button onclick="checkAndAddWinner()" type="button" class="btn secondary" style="width:100%;">
                    Registrar Ganador üéâ
                </button>
            </form>
            <button onclick="closeModal('winnerManagementModal')" class="btn outline" style="width:100%; margin-top:10px;">‚úñÔ∏è Cerrar</button>
        </div>
    </div>


    <script>
        // --- CONFIGURACI√ìN ---
        const ADMIN_PASS = "000-999"; 
        const STORAGE_KEY = "rifa_data_v8"; 
        const TOTAL_TICKETS = 1000;
        const MAX_RESERVATIONS_PER_USER = 3; // MAXIMO DE RESERVAS POR USUARIO A LA VEZ
        const FINAL_RAFFLE_DATE = new Date('2026-01-30T22:00:00'); // 30 de enero de 2026, 10 PM
        const WEEKLY_DRAW_DAY = 5; // 0=Domingo, 5=Viernes
        const WEEKLY_DRAW_HOUR = 22; // 10 PM (22:00)
        const RESERVATION_CLEARANCE_HOUR = 17; // 5 PM (17:00) Viernes para la liberaci√≥n semanal
        const RESERVATION_DURATION_MS = 24 * 60 * 60 * 1000; // 24 Horas
        const LAST_WEEKLY_DRAW = new Date('2026-01-23T22:00:00').getTime(); // √öltimo sorteo semanal

        // --- ESTADO INICIAL ---
        let appData = {
            tickets: [],   // { num, state, owner (email), reservedAt }
            users: [],     // { name, email, phone }
            currentUser: null,
            selectedTickets: [], 
            winners: [], // { date, num, winnerName, type, ownerEmail }
        };

        // --- FUNCIONES DE UTILIDAD ---

        function toast(msg, type='success') {
            const box = document.createElement('div');
            box.className = `toast ${type}`;
            // Ajustar color de texto para toast de advertencia si el tema es oscuro
            if (type === 'warning' && !document.body.classList.contains('light-mode')) {
                 box.style.color = '#000'; 
            }
            box.innerHTML = msg; 
            document.getElementById('toast-container').appendChild(box);
            setTimeout(() => {
                box.style.transition='opacity .4s, transform .4s'; 
                box.style.opacity='0'; 
                box.style.transform='translateX(8px)'; 
                setTimeout(()=>box.remove(),450);
            }, 4000);
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('open'); 
            // Limpiar valores del modal de verificar al cerrar
            if (id === 'verifyModal') {
                document.getElementById('verifyNum').value = '';
                document.getElementById('verifyResult').innerHTML = '<p style="color:var(--text-muted); margin:0;">Escribe un n√∫mero para verificar...</p>';
            }
        }
        function toggleTheme() { document.body.classList.toggle('light-mode'); }

        function formatNum(num) { 
            // Asegura que el n√∫mero sea tratado como entero y luego formateado
            return parseInt(num).toString().padStart(3, '0'); 
        }
        function formatUser(user) { return `${user.name} (${user.phone})`; }
        function getUserByEmail(email) { return appData.users.find(u => u.email === email); }
        function getCssVar(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // --- PERSISTENCIA Y CARGA / LIMPIEZA AUTOM√ÅTICA ---
        
        // Helper para obtener el timestamp del √∫ltimo corte de reservas del Viernes 17:00 que debi√≥ ocurrir
        function getWeeklyCutoffTime() {
            const now = new Date();
            let cutoff = new Date(now);
            cutoff.setHours(RESERVATION_CLEARANCE_HOUR, 0, 0, 0); // Establecer la hora a 17:00

            // 1. Calcular los d√≠as que han pasado desde el √∫ltimo Viernes (incluyendo hoy si es Viernes)
            let daysToRollback = (now.getDay() - WEEKLY_DRAW_DAY + 7) % 7; 
            cutoff.setDate(now.getDate() - daysToRollback);
            
            // 2. Si el tiempo calculado (Viernes 17:00) es posterior a la hora actual,
            // significa que estamos antes de las 17:00 de hoy Viernes. En ese caso, retrocedemos una semana.
            if (cutoff.getTime() > now.getTime()) {
                cutoff.setDate(cutoff.getDate() - 7);
            }
            
            return cutoff.getTime(); // Devuelve un timestamp
        }


        function load() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                appData = JSON.parse(saved);
                if (!appData.users) appData.users = [];
                if (!appData.selectedTickets) appData.selectedTickets = [];
                if (!appData.winners) appData.winners = [];
            } else {
                appData.tickets = [];
                for(let i=0; i<TOTAL_TICKETS; i++) {
                    appData.tickets.push({ num: formatNum(i), state: 'available', owner: null, reservedAt: null });
                }
            }
            
            const nowTimestamp = Date.now();
            
            // --- 1. Weekly Reservation Clearance (Friday 5 PM) ---
            const WEEKLY_CLEARANCE_KEY = "last_weekly_clearance_timestamp";
            let lastWeeklyClearanceTime = localStorage.getItem(WEEKLY_CLEARANCE_KEY);
            lastWeeklyClearanceTime = lastWeeklyClearanceTime ? parseInt(lastWeeklyClearanceTime) : 0;
            
            const requiredCutoffTime = getWeeklyCutoffTime();
            let weeklyClearanceNeeded = lastWeeklyClearanceTime < requiredCutoffTime;

            if (weeklyClearanceNeeded) {
                let weeklyClearedCount = 0;
                appData.tickets.forEach(t => {
                    if (t.state === 'reserved') {
                        t.state = 'available';
                        t.owner = null;
                        t.reservedAt = null;
                        weeklyClearedCount++;
                    }
                });
                
                if (weeklyClearedCount > 0) {
                    toast(`¬°Corte Semanal! ${weeklyClearedCount} reservas liberadas (Viernes 5 PM).`, 'accent');
                }
                
                // Si se realiz√≥ la limpieza semanal, se establece el nuevo timestamp de corte.
                localStorage.setItem(WEEKLY_CLEARANCE_KEY, nowTimestamp.toString()); 
                appData.selectedTickets = []; // Limpiar la selecci√≥n actual del usuario
            }
            
            // --- 2. Standard 24-Hour Expiration Check ---
            let reservationsExpired = 0;
            appData.tickets.forEach(t => {
                // Solo expira si no est√° afectado por el corte semanal (es decir, fue reservado DESPU√âS del √∫ltimo corte)
                if (t.state === 'reserved' && t.reservedAt && (nowTimestamp - t.reservedAt > RESERVATION_DURATION_MS)) {
                    t.state = 'available';
                    t.owner = null;
                    t.reservedAt = null;
                    reservationsExpired++;
                }
            });
            
            if (reservationsExpired > 0) {
                 toast(`Se liberaron ${reservationsExpired} reservas expiradas por tiempo (24h).`, 'warning');
            }
            
            // Actualizar la grilla y la UI inmediatamente
            renderGrid();
            updateUI();
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            updateUI(); 
        }

        function refreshData() {
            load(); 
            toast("Datos y contadores actualizados", 'success');
        }
        
        // --- CONTADOR Y FECHAS (Hora corregida a 10 PM) ---

        function getNextWeeklyDrawDate() {
            const today = new Date();
            const nowTime = today.getTime();
            
            // 1. Verificar si el gran sorteo final ya pas√≥
            if (nowTime >= FINAL_RAFFLE_DATE.getTime()) {
                return new Date(0); // Fecha en el pasado para indicar que termin√≥
            }

            // 2. Verificar si ya pasamos la fecha del √∫ltimo sorteo semanal
            if (nowTime > LAST_WEEKLY_DRAW) {
                return FINAL_RAFFLE_DATE; // Saltar directamente al sorteo final
            }
            
            let nextDraw = new Date(today);
            
            // Calcular d√≠as para el pr√≥ximo Viernes (WEEKLY_DRAW_DAY = 5)
            let daysToAdd = (WEEKLY_DRAW_DAY + 7 - today.getDay()) % 7;

            // Si es hoy (Viernes) y la hora ya pas√≥ (>= 10 PM), saltar al pr√≥ximo Viernes.
            if (daysToAdd === 0 && today.getHours() >= WEEKLY_DRAW_HOUR) {
                daysToAdd = 7;
            }
            
            nextDraw.setDate(today.getDate() + daysToAdd);
            
            // Establecer la hora a las 10:00 PM (22:00:00)
            nextDraw.setHours(WEEKLY_DRAW_HOUR, 0, 0, 0);
            
            return nextDraw;
        }

        function startCountdown() {
            // Se ejecuta cada segundo para mantener la cuenta regresiva en tiempo real
            const timer = setInterval(function() {
                const now = new Date().getTime();
                
                // --- Contador Semanal ---
                const nextDrawDate = getNextWeeklyDrawDate();
                const nextDrawTime = nextDrawDate.getTime();
                let distance = nextDrawTime - now;

                if (distance > 0 && nextDrawTime < FINAL_RAFFLE_DATE.getTime()) {
                    const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                    const s = Math.floor((distance % (1000 * 60)) / (1000)).toString().padStart(2, '0');
                    
                    document.getElementById("nextDrawTime").innerHTML = `${d}D ${h}:${m}:${s}`;
                } else if (nextDrawTime < FINAL_RAFFLE_DATE.getTime()) {
                    // Si la hora es el mismo viernes a las 10 PM
                    document.getElementById("nextDrawTime").innerHTML = "¬°HOY, A LAS 10 PM!";
                } else {
                    document.getElementById("nextDrawTime").innerHTML = "FINALIZADO";
                }

                // --- Contador Final ---
                distance = FINAL_RAFFLE_DATE.getTime() - now;
                if (distance > 0) {
                    const d_final = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const h_final = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                    const m_final = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                    const s_final = Math.floor((distance % (1000 * 60)) / (1000)).toString().padStart(2, '0');
                    document.getElementById("finalDrawTime").innerHTML = `${d_final}D ${h_final}:${m_final}:${s_final}`;
                } else {
                    document.getElementById("finalDrawTime").innerHTML = "¬°RIFA TERMINADA!";
                    clearInterval(timer); 
                }
            }, 1000);
        }

        // --- RENDERIZADO (GRID) y L√ìGICA DE SELECCI√ìN ---
        function toggleTicketSelection(num) {
            if (!appData.currentUser) {
                toast("Debes identificarte para seleccionar n√∫meros.", 'error');
                return openModal('loginModal');
            }

            const ticket = appData.tickets.find(t => t.num === num);
            if (!ticket || ticket.state !== 'available') {
                toast(`El n√∫mero ${num} no est√° disponible.`, 'error');
                return;
            }

            const index = appData.selectedTickets.indexOf(num);
            if (index > -1) {
                appData.selectedTickets.splice(index, 1);
            } else {
                // IMPLEMENTACI√ìN: L√≠mite de 3 reservas
                if (appData.selectedTickets.length >= MAX_RESERVATIONS_PER_USER) {
                    toast(`Solo puedes reservar un m√°ximo de ${MAX_RESERVATIONS_PER_USER} n√∫meros a la vez.`, 'error');
                    return;
                }
                appData.selectedTickets.push(num);
            }
            renderGrid();
            updateUI();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const searchInput = document.getElementById('searchInput').value.trim();
            const filterValue = document.getElementById('filterSelect').value;
            grid.innerHTML = '';
            
            const filteredTickets = appData.tickets.filter(t => {
                const matchesSearch = searchInput ? t.num.includes(searchInput) : true;
                const matchesFilter = filterValue === 'all' || t.state === filterValue;
                return matchesSearch && matchesFilter;
            });

            filteredTickets.forEach(ticket => {
                const card = document.createElement('div');
                card.className = `card ${ticket.state}`;
                card.innerHTML = `<div class="num">${ticket.num}</div><div class="status-text">${ticket.state.toUpperCase()}</div>`;
                card.setAttribute('data-num', ticket.num);

                let ownerInfo = "";
                if (ticket.owner) {
                    const user = getUserByEmail(ticket.owner);
                    ownerInfo = user ? `${user.name} (${user.phone})` : `Owner: ${ticket.owner}`;
                    card.setAttribute('data-owner-info', ownerInfo);
                }

                if (ticket.state === 'available') {
                    card.onclick = () => toggleTicketSelection(ticket.num);
                    if (appData.selectedTickets.includes(ticket.num)) {
                        card.classList.add('selected');
                    }
                } else if (appData.currentUser && ticket.owner === appData.currentUser.email) {
                    card.classList.add('mine');
                }

                grid.appendChild(card);
            });
        }

        function updateUI() {
            // Actualizar Contadores
            const stats = appData.tickets.reduce((acc, t) => {
                acc[t.state]++;
                return acc;
            }, { available: 0, reserved: 0, paid: 0 });

            document.getElementById('statAvail').textContent = stats.available;
            document.getElementById('statRes').textContent = stats.reserved;
            document.getElementById('statPaid').textContent = stats.paid;
            // Total siempre es 1000, pero se mantiene la l√≠nea por si se cambia la configuraci√≥n.
            document.getElementById('statTotal').textContent = TOTAL_TICKETS; 

            // Actualizar Bot√≥n de Reserva M√∫ltiple
            const selectedCount = appData.selectedTickets.length;
            const btn = document.getElementById('multiReserveBtn');
            document.getElementById('selectedCount').textContent = selectedCount;
            btn.style.display = selectedCount > 0 ? 'block' : 'none';

            // Actualizar estado de autenticaci√≥n
            const btnAuth = document.getElementById('btnAuth');
            if (appData.currentUser) {
                btnAuth.textContent = `üëã ${appData.currentUser.name.split(' ')[0]}`;
                btnAuth.onclick = checkMyTickets;
            } else {
                btnAuth.textContent = `Ingresar`;
                btnAuth.onclick = () => openModal('loginModal');
            }
        }

        // --- L√ìGICA DE COMPRA Y RESERVA ---

        function handleLogin(event) {
            event.preventDefault();
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();

            let user = getUserByEmail(email);
            if (!user) {
                user = { name, email, phone };
                appData.users.push(user);
            } else {
                // Actualizar datos del usuario si ya existe
                user.name = name;
                user.phone = phone;
            }
            
            appData.currentUser = user;
            save();
            closeModal('loginModal');
            toast(`Bienvenido, ${name}`, 'success');
            
            // Si el usuario ten√≠a n√∫meros seleccionados, iniciar la confirmaci√≥n
            if (appData.selectedTickets.length > 0) {
                confirmReservation();
            }
        }

        function confirmReservation() {
            if (!appData.currentUser) {
                return openModal('loginModal');
            }

            const count = appData.selectedTickets.length;
            if (count === 0) return toast("Debes seleccionar al menos un n√∫mero.", 'warning');

            const nums = appData.selectedTickets.join(', ');
            
            if (confirm(`¬øConfirmas la reserva de ${count} n√∫mero(s): ${nums} a nombre de ${appData.currentUser.name}? Las reservas vencen en 24 horas si no se pagan.`)) {
                
                appData.selectedTickets.forEach(num => {
                    const ticket = appData.tickets.find(t => t.num === num);
                    // Solo reservar si sigue disponible (evita problemas de doble clic o multitarea)
                    if (ticket && ticket.state === 'available') { 
                        ticket.state = 'reserved';
                        ticket.owner = appData.currentUser.email;
                        ticket.reservedAt = Date.now();
                    }
                });

                appData.selectedTickets = []; // Limpiar selecci√≥n
                save();
                toast(`¬°Reserva exitosa! Tienes 24h para pagar los n√∫meros: ${nums}`, 'success');
                showInstructions(); // Muestra las instrucciones de pago
            }
            
            renderGrid(); // Refrescar grid despu√©s de la confirmaci√≥n
        }

        // IMPLEMENTACI√ìN: Compra r√°pida de 1, 2 o 3 boletas
        function quickBuy(count) {
            if (!appData.currentUser) {
                toast("Debes identificarte para comprar n√∫meros.", 'error');
                return openModal('loginModal');
            }

            // Asegurar que no exceda el l√≠mite de MAX_RESERVATIONS_PER_USER
            if (count > MAX_RESERVATIONS_PER_USER) count = MAX_RESERVATIONS_PER_USER;
            
            // 1. Limpiar cualquier selecci√≥n previa
            appData.selectedTickets = []; 

            // 2. Encontrar boletas disponibles
            const availableTickets = appData.tickets.filter(t => t.state === 'available');
            
            if (availableTickets.length < count) {
                toast("No hay suficientes boletas disponibles para tu compra.", 'error');
                return;
            }
            
            // 3. Seleccionar las primeras 'count' boletas disponibles
            for (let i = 0; i < count; i++) {
                appData.selectedTickets.push(availableTickets[i].num);
            }
            
            // 4. Iniciar el flujo de reserva
            renderGrid();
            updateUI();
            
            // Llama a confirmReservation para finalizar la reserva y mostrar el mensaje
            confirmReservation();
        }

        function showInstructions() {
             alert(`PASOS PARA EL PAGO DE BOLETAS RESERVADAS:\n\n1. Valor: $25.000 COP por boleta.\n2. Realiza el pago por Nequi o Daviplata al n√∫mero:\n   üìû 321 963 7388 (√ìscar Fidel Fl√≥rez Tami)\n3. Env√≠a el comprobante de pago al WhatsApp del administrador (el bot√≥n flotante).\n4. Un administrador verificar√° tu pago y cambiar√° el estado de tu(s) boleta(s) a 'Pagada' (Color ROJO).\n\n¬°Recuerda, tienes 24 horas para asegurar tus n√∫meros, o ser√°n liberados el viernes a las 5 PM!`);
        }

        function checkMyTickets() {
            if(!appData.currentUser) return openModal('loginModal');
            
            const myTickets = appData.tickets.filter(t => t.owner === appData.currentUser.email);
            if (myTickets.length === 0) {
                return alert("A√∫n no tienes n√∫meros reservados o comprados. ¬°Es tu momento!");
            }

            const reserved = myTickets.filter(t => t.state === 'reserved').map(t => t.num).join(', ') || 'Ninguna';
            const paid = myTickets.filter(t => t.state === 'paid').map(t => t.num).join(', ') || 'Ninguna';
            
            let msg = `TUS BOLETAS REGISTRADAS (${myTickets.length} en total):\n\n`;
            msg += `‚è≥ RESERVADAS (PAGO PENDIENTE):\n${reserved}\n\n`;
            msg += `‚úÖ PAGADAS (ASEGURADAS):\n${paid}`;
            
            alert(msg);
        }

        // --- L√ìGICA DE ADMINISTRACI√ìN ---

        function openAdminAuth() {
            const pass = prompt("Ingrese la contrase√±a de administrador:");
            if (pass === ADMIN_PASS) {
                appData.currentUser = { name: 'Admin', email: 'admin@admin.com', phone: 'N/A' }; // Set temporalmente como Admin para UI
                renderAdminLists();
                openModal('adminModal');
            } else if (pass !== null) {
                toast("Contrase√±a incorrecta.", 'error');
            }
        }
        
        function renderAdminLists() {
            const reservedBody = document.getElementById('reservedTicketListBody');
            const paidBody = document.getElementById('paidTicketListBody');
            reservedBody.innerHTML = '';
            paidBody.innerHTML = '';
            
            // Reservados
            const reserved = appData.tickets.filter(t => t.state === 'reserved');
            reserved.forEach(t => {
                const user = getUserByEmail(t.owner);
                // Calcular tiempo restante o tiempo transcurrido
                const remainingMs = t.reservedAt + RESERVATION_DURATION_MS - Date.now();
                const timeText = remainingMs > 0 
                    ? `(${Math.ceil(remainingMs / (1000 * 60 * 60))}h restantes)`
                    : `(EXPIRADA)`;
                
                const row = reservedBody.insertRow();
                row.innerHTML = `
                    <td>${t.num}</td>
                    <td>${user ? formatUser(user) : t.owner} ${timeText}</td>
                    <td>
                        <button onclick="adminSetState('${t.num}', 'paid')" class="btn accent" style="padding: 5px 10px; font-size: 0.7rem;">Pagar</button>
                        <button onclick="adminSetState('${t.num}', 'available')" class="btn outline" style="padding: 5px 10px; font-size: 0.7rem;">Liberar</button>
                    </td>
                `;
            });

            // Pagados
            const paid = appData.tickets.filter(t => t.state === 'paid');
            paid.forEach(t => {
                const user = getUserByEmail(t.owner);
                const row = paidBody.insertRow();
                row.innerHTML = `
                    <td>${t.num}</td>
                    <td>${user ? formatUser(user) : t.owner}</td>
                    <td>
                        <button onclick="adminSetState('${t.num}', 'available')" class="btn warning" style="padding: 5px 10px; font-size: 0.7rem;">Liberar</button>
                    </td>
                `;
            });
            renderUserList();
            
            // Mostrar bot√≥n de eliminaci√≥n de historial de ganadores si el admin est√° logueado
            document.getElementById('btnAdminDeleteWinner').style.display = appData.currentUser && appData.currentUser.email === 'admin@admin.com' ? 'block' : 'none';
        }
        
        function renderUserList() {
            const body = document.getElementById('userListBody');
            const search = document.getElementById('adminUserSearch').value.toLowerCase();
            body.innerHTML = '';

            const filteredUsers = appData.users.filter(u => 
                u.name.toLowerCase().includes(search) || u.phone.includes(search)
            );

            filteredUsers.forEach(user => {
                const tickets = appData.tickets.filter(t => t.owner === user.email);
                const status = tickets.length > 0 ? `(${tickets.length} boletas)` : 'Sin boletas';
                const row = body.insertRow();
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${status}</td>
                    <td>
                        <button onclick="adminRemoveUser('${user.email}')" class="btn accent" style="padding: 5px 10px; font-size: 0.7rem;">Eliminar</button>
                    </td>
                `;
            });
        }
        
        function adminRemoveUser(email) {
            if (confirm(`¬øEst√°s seguro de ELIMINAR al cliente con email ${email}? Sus boletas NO se liberar√°n autom√°ticamente; aseg√∫rese de liberarlas manualmente en la lista de 'Pagadas'/'Reservadas' primero.`)) {
                appData.users = appData.users.filter(u => u.email !== email);
                save();
                renderAdminLists();
                toast("Cliente eliminado.", 'warning');
            }
        }

        function adminSetState(num, newState) {
            const ticket = appData.tickets.find(t => t.num === num);
            if (!ticket) return;

            if (newState === 'available') {
                // Liberar la boleta
                ticket.state = 'available';
                ticket.owner = null;
                ticket.reservedAt = null;
            } else if (newState === 'paid') {
                // Marcar como pagada
                ticket.state = 'paid';
                if (!ticket.owner) {
                    // Si no tiene due√±o, requiere asignaci√≥n manual primero
                    return toast("Error: Esta boleta no tiene due√±o asignado. Use 'Asignar Manual' primero.", 'error');
                }
                if (!ticket.reservedAt) ticket.reservedAt = Date.now(); 
            }
            
            save();
            renderAdminLists(); // Refrescar la vista del admin
            renderGrid(); // Refrescar la vista p√∫blica
            toast(`Boleta ${num} cambiada a ${newState.toUpperCase()}`, 'success');
        }

        function openManualAssignModal() {
            closeModal('adminModal');
            // Limpiar campos del modal al abrir
            document.getElementById('manualNum').value = '';
            document.getElementById('manualName').value = '';
            document.getElementById('manualPhone').value = '';
            openModal('manualAssignModal');
        }

        function handleManualAssign(event, state) {
            event.preventDefault();
            const num = document.getElementById('manualNum').value.padStart(3, '0');
            const name = document.getElementById('manualName').value.trim();
            const phone = document.getElementById('manualPhone').value.trim();
            
            // Usar el n√∫mero de tel√©fono como identificador √∫nico para el "email" manual
            const uniqueEmail = `manual_${phone.replace(/\D/g, '')}@riffa.com`; 

            const ticket = appData.tickets.find(t => t.num === num);

            if (!ticket) return toast("N√∫mero de boleta inv√°lido.", 'error');
            if (ticket.state !== 'available') return toast(`El n√∫mero ${num} ya est√° ${ticket.state}.`, 'error');

            // Crear o actualizar usuario
            let user = getUserByEmail(uniqueEmail);
            if (!user) {
                user = { name, email: uniqueEmail, phone };
                appData.users.push(user);
            } else {
                 user.name = name; // Asegurar el nombre est√° actualizado
            }


            ticket.state = state;
            ticket.owner = uniqueEmail;
            ticket.reservedAt = Date.now();

            save();
            closeModal('manualAssignModal');
            toast(`Asignaci√≥n manual de ${num} como ${state.toUpperCase()} exitosa.`, 'success');
            openModal('adminModal'); // Volver al panel de administraci√≥n
        }

        // --- GESTI√ìN DE SORTEOS ---
        function previewWinnerInfo() {
            const numInput = document.getElementById('winnerNum');
            const num = numInput.value.padStart(3, '0');
            const info = document.getElementById('winnerInfo');
            
            // Obtener variables CSS para usar en JS
            const primaryColor = getCssVar('--primary');
            const accentColor = getCssVar('--accent');
            const warningColor = getCssVar('--warning');
            
            if (num.length !== 3) {
                info.textContent = 'Ingrese un n√∫mero de 3 d√≠gitos (ej: 123)';
                return;
            }
            
            const ticket = appData.tickets.find(t => t.num === num);
            if (!ticket) {
                info.innerHTML = `‚ö†Ô∏è El n√∫mero <span style="color: ${accentColor};">${num}</span> no existe.`;
                return;
            }

            const status = ticket.state;
            if (status === 'available') {
                info.innerHTML = `üö´ El n√∫mero <span style="color: ${primaryColor};">${num}</span> est√° **LIBRE**. No hay un ganador pagado.`;
            } else if (status === 'reserved') {
                const user = getUserByEmail(ticket.owner);
                info.innerHTML = `‚è≥ El n√∫mero <span style="color: ${warningColor};">${num}</span> est√° **RESERVADO** por **${user ? user.name : ticket.owner}**. ¬°A√∫n no est√° PAGADO!`;
            } else if (status === 'paid') {
                const user = getUserByEmail(ticket.owner);
                info.innerHTML = `‚úÖ ¬°GANADOR! El n√∫mero <span style="color: ${accentColor};">${num}</span> est√° **PAGADO** por **${user ? user.name : ticket.owner}**.`;
            }
        }
        
        function openWinnerManagement() {
            closeModal('adminModal');
            document.getElementById('winnerDate').valueAsDate = new Date();
            // Asegurarse de que la previsualizaci√≥n funcione al abrir el modal
            document.getElementById('winnerNum').value = '';
            document.getElementById('winnerInfo').textContent = 'Ingrese un n√∫mero de 3 d√≠gitos (ej: 123)';
            openModal('winnerManagementModal');
        }

        function checkAndAddWinner() {
            const num = document.getElementById('winnerNum').value.padStart(3, '0');
            const date = document.getElementById('winnerDate').value;
            const type = document.getElementById('winnerType').value;
            
            const ticket = appData.tickets.find(t => t.num === num);
            if (!ticket) return toast("N√∫mero ganador inv√°lido (debe ser 3 cifras).", 'error');

            const ownerInfo = ticket.owner ? getUserByEmail(ticket.owner) : null;
            const winnerName = ownerInfo ? ownerInfo.name : "Nadie (Boleta Libre)";
            const ownerEmail = ticket.owner || "available";

            if (ticket.state !== 'paid') {
                if (!confirm(`ADVERTENCIA: El ganador de la loter√≠a es ${num}, pero la boleta est√° como ${ticket.state.toUpperCase()} (${winnerName}). ¬øDesea registrarlo como ganador de todos modos? Esto es solo para fines de registro hist√≥rico, no confirma el premio si no est√° pagado.`)) {
                    // Si el admin cancela, salir
                    if (!confirm("Si cancela, el sorteo no se registrar√°. ¬øDesea continuar?")) return;
                }
            } else {
                if (!confirm(`CONFIRMAR: Registrar a ${winnerName} con el n√∫mero ${num} como ganador del Sorteo ${type.toUpperCase()} del ${date}?`)) {
                    return;
                }
            }

            // Verificar si ya existe un sorteo para esta fecha y tipo
            const exists = appData.winners.some(w => w.date === date && w.type === type);
            if (exists && !confirm(`ADVERTENCIA: Ya existe un ganador registrado para el sorteo ${type.toUpperCase()} de la fecha ${date}. ¬øDesea registrar este nuevo resultado y duplicar el registro?`)) {
                return;
            }

            const newWinner = { date, num, winnerName, type, ownerEmail };
            appData.winners.unshift(newWinner); 

            // Liberar la boleta si es el sorteo final
            if (type === 'final' && ticket.state !== 'available') {
                adminSetState(num, 'available');
            }

            save();
            closeModal('winnerManagementModal');
            toast(`Ganador ${winnerName} registrado para ${num}.`, 'success');
        }

        function openWinnerHistory() {
            renderWinnerHistory();
            openModal('winnerHistoryModal');
        }

        function renderWinnerHistory() {
            const body = document.getElementById('winnerListBody');
            body.innerHTML = '';
            
            const totalWeeklyDraws = 18; // N√∫mero de semanas entre el inicio estimado y 23/01/2026.
            const completedWeeklyDraws = appData.winners.filter(w => w.type === 'weekly').length;
            const weeklyDrawsLeft = Math.max(0, totalWeeklyDraws - completedWeeklyDraws);
            const finalDrawn = appData.winners.some(w => w.type === 'final');

            appData.winners.forEach(w => {
                const row = body.insertRow();
                row.style.color = w.type === 'final' ? getCssVar('--accent') : getCssVar('--warning');
                row.innerHTML = `
                    <td>${w.date}</td>
                    <td>${w.type === 'final' ? 'FINAL' : 'Semanal (1M)'}</td>
                    <td><strong style="font-size: 1.1rem;">${w.num}</strong></td>
                    <td>${w.winnerName}</td>
                `;
            });


            const remainingText = `Sorteos semanales registrados: ${completedWeeklyDraws}. Estimados restantes: ${weeklyDrawsLeft}. Sorteo Final: ${finalDrawn ? 'Realizado' : 'PENDIENTE'}.`;
            document.getElementById('drawsRemaining').textContent = remainingText;
        }

        function deleteWinnerHistory() {
            if (confirm("ADVERTENCIA: ¬øEst√°s seguro de ELIMINAR TODO el historial de ganadores? Esta acci√≥n no se puede deshacer.")) {
                appData.winners = [];
                save();
                renderWinnerHistory();
                toast("Historial de ganadores eliminado.", 'warning');
            }
        }
        
        // --- OTRAS FUNCIONES DE UTILIDAD ---

        function verifyTicket() {
            const numInput = document.getElementById('verifyNum');
            const num = numInput.value.padStart(3, '0');
            const resultBox = document.getElementById('verifyResult');

            if (num.length !== 3) {
                resultBox.innerHTML = '<p style="color:var(--text-muted); margin:0;">Escribe un n√∫mero de 3 d√≠gitos (ej: 045)...</p>';
                return;
            }

            const ticket = appData.tickets.find(t => t.num === num);

            if (!ticket) {
                 resultBox.innerHTML = `<p style="color:var(--accent); margin:0;">El n√∫mero ${num} no se encontr√≥. Error de datos.</p>`;
                 return;
            }

            let statusText;
            let ownerName = "";
            let color = getCssVar('--text-muted');

            if (ticket.state === 'available') {
                statusText = 'DISPONIBLE (C√ìMPRALO YA)';
                color = getCssVar('--primary');
            } else {
                const user = getUserByEmail(ticket.owner);
                ownerName = user ? ` (${user.name})` : ' (Venta manual)';
                if (ticket.state === 'reserved') {
                    statusText = 'RESERVADO (PAGO PENDIENTE)';
                    color = getCssVar('--warning');
                } else if (ticket.state === 'paid') {
                    statusText = 'PAGADO (BOLETA ASEGURADA)';
                    color = getCssVar('--accent');
                }
            }
            
            resultBox.innerHTML = `<p style="margin:0; font-weight: bold; color: ${color};">N√∫mero: ${num} | Estado: ${statusText}${ownerName}</p>`;
        }
        
        // Funci√≥n para resetear completamente la aplicaci√≥n (Solo para Admin)
        function adminResetRaffle() {
            if (confirm("ADVERTENCIA CR√çTICA: ¬øEst√°s ABSOLUTAMENTE SEGURO de que deseas restablecer la Rifa? Esto eliminar√° todos los datos de tickets, usuarios, reservas y ganadores de forma permanente.")) {
                localStorage.removeItem(STORAGE_KEY);
                // Tambi√©n limpiar el timestamp del corte semanal
                localStorage.removeItem("last_weekly_clearance_timestamp"); 
                location.reload();
            }
        }

        function exportData(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toast(`Exportando ${filename}...`, 'success');
        }

        function exportAllData() {
            exportData(appData, `Rifa_Data_Completa_${new Date().toISOString().slice(0, 10)}.json`);
        }

        function exportPaidTickets() {
            const paid = appData.tickets.filter(t => t.state === 'paid').map(t => {
                const user = getUserByEmail(t.owner);
                return {
                    numero: t.num,
                    estado: 'PAGADO',
                    nombre: user ? user.name : 'N/A',
                    celular: user ? user.phone : 'N/A',
                    email: t.owner
                };
            });
            exportData(paid, `Rifa_Boletas_Pagadas_${new Date().toISOString().slice(0, 10)}.json`);
        }


        // --- INICIALIZACI√ìN AL CARGAR LA P√ÅGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            load();
            startCountdown();
            
            // Asignaci√≥n de event listeners para el filtrado/b√∫squeda
            document.getElementById('searchInput').addEventListener('input', renderGrid);
            document.getElementById('filterSelect').addEventListener('change', renderGrid);

            // Listener para el input de nombre en el modal de login (para el saludo)
            const userNameInput = document.getElementById('userName');
            const loginTitle = document.getElementById('loginTitle');
            if (userNameInput && loginTitle) {
                userNameInput.addEventListener('input', () => {
                    const name = userNameInput.value.trim();
                    loginTitle.textContent = name.length > 0 ? `üëã Hola, ${name.split(' ')[0]}` : `üë§ Identif√≠cate`; 
                });
            }
        });
    </script>
</body>
</html>
